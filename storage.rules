rules_version = '2';

// Firebase Storage Security Rules
// G√®re les permissions d'acc√®s aux fichiers stock√©s (avatars)

service firebase.storage {
  match /b/{bucket}/o {
    
    // ===================== HELPER FUNCTIONS =====================
    
    /// V√©rifie si l'utilisateur est authentifi√©
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /// V√©rifie si le fichier est une image
    function isImageFile() {
      return request.resource.contentType.matches('image/.*');
    }
    
    /// V√©rifie si la taille du fichier est valide (< 5MB)
    function isValidSize() {
      return request.resource.size < 5 * 1024 * 1024; // 5MB
    }
    
    /// V√©rifie si l'utilisateur est admin
    /// Note: N√©cessite une requ√™te √† Firestore (co√ªte en lecture)
    function isAdmin() {
      return isAuthenticated() 
        && firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.roles.admin == true;
    }
    
    // ===================== AVATARS =====================
    
    /// Avatars des personnages
    /// Path: /avatars/{personnageId}/avatar.jpg
    match /avatars/{personnageId}/{fileName} {
      
      // üîç LECTURE
      // Tous les utilisateurs authentifi√©s peuvent voir les avatars
      allow read: if isAuthenticated();
      
      // ‚úèÔ∏è √âCRITURE (CREATE/UPDATE)
      // Utilisateur authentifi√© + image valide + taille OK
      // TODO: V√©rifier que l'utilisateur a acc√®s au personnage via Firestore
      allow write: if isAuthenticated()
        && isImageFile()
        && isValidSize();
      
      // ‚ùå SUPPRESSION
      // Utilisateur authentifi√© ou admin
      // TODO: V√©rifier que l'utilisateur est MJ de la campagne
      allow delete: if isAuthenticated() || isAdmin();
    }
    
    // ===================== AUTRES FICHIERS =====================
    
    /// Par d√©faut, aucun acc√®s
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

// ===================== NOTES =====================
//
// LIMITATIONS:
// - Les requ√™tes Firestore dans les rules Storage co√ªtent des lectures
// - √âviter d'utiliser firestore.get() dans isAdmin() si possible
// - Pr√©f√©rer valider c√¥t√© client ou via Cloud Functions
//
// AM√âLIORATIONS FUTURES:
// - V√©rifier que le personnageId existe dans une campagne accessible
// - V√©rifier que l'utilisateur est MJ ou propri√©taire du personnage
// - Ajouter limitation du nombre d'uploads par jour
// - Ajouter support pour miniatures (thumbnails)
//
// D√âPLOIEMENT:
// D√©ployer avec: firebase deploy --only storage
